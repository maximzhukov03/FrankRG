<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>FrankRG Test</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="controls">
    <input id="uploadInput" type="file" />
    <button onclick="uploadFile()">Загрузить</button>
    <button onclick="mkdir()">Создать папку</button>
  </div>

  <p>Текущий путь: <span id="currentPath">.</span></p>

  <table id="files">
    <thead>
      <tr><th>Имя</th><th>Тип</th><th>Размер</th><th>Изменено</th><th>Действия</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let currentPath = ".";

    async function loadList() {
      const resp = await fetch(`/api/list?path=${encodeURIComponent(currentPath)}`);
      const data = await resp.json();
      const tbody = document.querySelector("#files tbody");
      tbody.innerHTML = "";

      if (currentPath !== ".") {
        const up = document.createElement("tr");
        up.innerHTML = `<td class="dir">..</td><td>DIR</td><td></td><td></td>
                        <td class="actions"><button onclick="goUp()">⬆ Назад</button></td>`;
        tbody.appendChild(up);
      }

      for (const item of data.items) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="dir">${item.Name}</td>
          <td>${item.Type === 0 ? "DIR" : "FILE"}</td>
          <td>${item.Type === 1 ? formatSize(item.Size) : ""}</td>
          <td>${new Date(item.TimeModification).toLocaleString()}</td>
          <td class="actions"></td>
        `;

        const actions = tr.querySelector(".actions");

        if (item.Type === 0) {
          const goBtn = document.createElement("button");
          goBtn.textContent = "Перейти";
          goBtn.onclick = () => goToDir(item.Name);
          actions.appendChild(goBtn);
        } else {
          const dlBtn = document.createElement("button");
          dlBtn.textContent = "Скачать";
          dlBtn.onclick = () =>
            window.location = `/api/download?path=${encodeURIComponent(currentPath + "/" + item.Name)}`;
          actions.appendChild(dlBtn);
        }

        const delBtn = document.createElement("button");
        delBtn.textContent = "Удалить";
        delBtn.onclick = () => deleteItem(item.Name);
        actions.appendChild(delBtn);

        tbody.appendChild(tr);
      }

      document.getElementById("currentPath").textContent = currentPath;
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / (1024 * 1024)).toFixed(1) + " MB";
    }

    function goToDir(name) {
      currentPath = currentPath === "." ? name : `${currentPath}/${name}`;
      loadList();
    }

    function goUp() {
      currentPath = currentPath.split("/").slice(0, -1).join("/") || ".";
      loadList();
    }

    async function mkdir() {
      const name = prompt("Имя новой папки:");
      if (!name) return;
      await fetch("/api/mkdir", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({path: currentPath, name})
      });
      loadList();
    }

    async function deleteItem(name) {
      if (!confirm(`Удалить ${name}?`)) return;
      await fetch("/api/delete", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({path: currentPath, name})
      });
      loadList();
    }

    async function uploadFile() {
      const file = document.getElementById("uploadInput").files[0];
      if (!file) return alert("Выберите файл!");
      const fd = new FormData();
      fd.append("file", file);
      fd.append("name", file.name);
      await fetch(`/api/upload?path=${encodeURIComponent(currentPath)}`, {
        method: "POST",
        body: fd
      });
      loadList();
    }

    loadList();
  </script>
</body>
</html>